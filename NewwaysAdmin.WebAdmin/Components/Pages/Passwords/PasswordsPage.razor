@* File: NewwaysAdmin.WebAdmin/Components/Pages/Passwords/PasswordsPage.razor *@

@page "/passwords"
@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using NewwaysAdmin.Shared.Services.Passwords
@using NewwaysAdmin.WebAdmin.Services.Auth

@inject PasswordService PasswordService
@inject IAuthenticationService AuthService
@inject IJSRuntime JS
@inject ILogger<PasswordsPage> Logger

<PageTitle>Passwords</PageTitle>

@if (!_isAdmin)
{
    <div class="alert alert-danger">
        <h4>Access Denied</h4>
        <p>You do not have permission to access this page.</p>
    </div>
}
else
{
    <div class="container-fluid mt-4">
        @* Header *@
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-key"></i> Passwords</h2>
            <button class="btn btn-primary" @onclick="ShowAddModal">
                <i class="bi bi-plus-lg"></i> Add Password
            </button>
        </div>

        @* Feedback message *@
        @if (!string.IsNullOrEmpty(_message))
        {
            <div class="alert @(_messageIsError ? "alert-danger" : "alert-success") alert-dismissible fade show">
                @_message
                <button type="button" class="btn-close" @onclick="() => _message = null"></button>
            </div>
        }

        @* Password table *@
        @if (_isLoading)
        {
            <div class="text-center p-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }
        else if (_entries.Count == 0)
        {
            <div class="alert alert-info">
                <h5>No passwords stored yet</h5>
                <p class="mb-0">Click "Add Password" to store your first password.</p>
            </div>
        }
        else
        {
            <div class="card">
                <div class="card-body p-0">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 25%">Password for</th>
                                <th style="width: 20%">Username</th>
                                <th style="width: 25%">Password</th>
                                <th style="width: 20%">Note</th>
                                <th style="width: 10%"></th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var entry in _entries)
                            {
                                <NewwaysAdmin.WebAdmin.Components.Passwords.PasswordRow Entry="entry"
                                                                                        OnDelete="@(async (id) => await DeletePassword(id))"
                                                                                        OnCopy="@(async (text) => await CopyToClipboard(text))" />
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        }
    </div>

    @* Add Password Modal *@
    <NewwaysAdmin.WebAdmin.Components.Passwords.AddPasswordModal @ref="_addModal"
                                                                 OnSave="AddPassword"
                                                                 OnCancel="() => { }" />
}

@code {
    private List<PasswordEntry> _entries = new();
    private bool _isLoading = true;
    private bool _isAdmin = false;
    private string? _message;
    private bool _messageIsError;
    private NewwaysAdmin.WebAdmin.Components.Passwords.AddPasswordModal? _addModal;

    protected override async Task OnInitializedAsync()
    {
        var session = await AuthService.GetCurrentSessionAsync();
        _isAdmin = session?.IsAdmin ?? false;

        if (_isAdmin)
        {
            await LoadPasswords();
        }

        _isLoading = false;
    }

    private async Task LoadPasswords()
    {
        try
        {
            _entries = await PasswordService.GetAllAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load passwords");
            ShowMessage("Failed to load passwords", true);
        }
    }

    private void ShowAddModal()
    {
        _addModal?.Show();
    }

    private async Task AddPassword(PasswordEntry entry)
    {
        try
        {
            var session = await AuthService.GetCurrentSessionAsync();
            var username = session?.Username ?? "Unknown";

            await PasswordService.AddAsync(entry, username);
            await LoadPasswords();
            ShowMessage($"Password '{entry.Label}' added successfully", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add password");
            ShowMessage("Failed to add password", true);
        }
    }

    private async Task DeletePassword(string id)
    {
        try
        {
            await PasswordService.DeleteAsync(id);
            await LoadPasswords();
            ShowMessage("Password deleted", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to delete password");
            ShowMessage("Failed to delete password", true);
        }
    }

    private async Task CopyToClipboard(string text)
    {
        try
        {
            await JS.InvokeVoidAsync("navigator.clipboard.writeText", text);
            ShowMessage("Copied to clipboard", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to copy to clipboard");
            ShowMessage("Failed to copy to clipboard", true);
        }
    }

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _messageIsError = isError;
    }
}