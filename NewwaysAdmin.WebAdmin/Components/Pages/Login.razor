@page "/login"
@using NewwaysAdmin.WebAdmin.Models.Auth
@using NewwaysAdmin.WebAdmin.Services.Auth
@using NewwaysAdmin.WebAdmin.Authentication
@using NewwaysAdmin.WebAdmin.Security
@using Microsoft.AspNetCore.Components.Authorization

@inject IAuthenticationService AuthService
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthStateProvider
@inject ILogger<Login> Logger
@inject IJSRuntime JSRuntime
@inject IHttpContextAccessor HttpContextAccessor

<div class="login-container">
    <div class="login-card">
        <div class="card">
            <div class="card-header card-header-thiel">
                <h3 class="mb-0">Login</h3>
            </div>
            <div class="card-body">
                <EditForm Model="@loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />

                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                            <div class="alert alert-danger">@errorMessage</div>
                    }

                    <div class="mb-4">
                        <label for="username" class="form-label fw-bold">Username</label>
                        <InputText id="username" class="form-control form-control-lg" @bind-Value="loginModel.Username" />
                        <ValidationMessage For="@(() => loginModel.Username)" />
                    </div>

                    <div class="mb-4">
                        <label for="password" class="form-label fw-bold">Password</label>
                        <InputText type="password" id="password" class="form-control form-control-lg" @bind-Value="loginModel.Password" />
                        <ValidationMessage For="@(() => loginModel.Password)" />
                    </div>

                    <button type="submit" class="btn btn-secondary w-100 btn-lg" disabled="@isLoading">
                        @if (isLoading)
                        {
                                <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
                                <span class="ms-2">Logging in...</span>
                        }
                        else
                        {
                                <span>Login</span>
                        }
                    </button>
                </EditForm>
            </div>
        </div>
    </div>
</div>

@code {
    private LoginModel loginModel = new();
    private string? errorMessage;
    private bool isLoading;

    protected override async Task OnInitializedAsync()
    {
        // Check if user is already logged in
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        if (authState.User.Identity?.IsAuthenticated ?? false)
        {
            NavigationManager.NavigateTo("/");
        }
    }

    private async Task HandleLogin()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            // Get client IP for tracking
            var clientIp = GetClientIp();

            var (success, error) = await AuthService.LoginAsync(loginModel);

            if (success)
            {
                // SUCCESS - Clear any failed attempts for this IP
                AuthGateMiddleware.RecordSuccessfulLogin(clientIp, Logger);

                var session = await AuthService.GetCurrentSessionAsync();
                if (session != null)
                {
                    // Update Blazor authentication state
                    if (AuthStateProvider is CustomAuthenticationStateProvider customProvider)
                    {
                        await customProvider.NotifyUserAuthenticationAsync(session);
                    }

                    // Navigate with sessionId in query - middleware will set the cookie
                    NavigationManager.NavigateTo($"/home?sessionId={session.SessionId}");
                }
                else
                {
                    errorMessage = "Session creation failed";
                }
            }
            else
            {
                // FAILED - Record the failed attempt
                AuthGateMiddleware.RecordFailedLogin(clientIp, Logger);

                // Check if IP is now banned
                var (attempts, isBanned, bannedUntil) = AuthGateMiddleware.GetStatus(clientIp);

                if (isBanned)
                {
                    var minutes = (int)(bannedUntil!.Value - DateTime.UtcNow).TotalMinutes;
                    errorMessage = $"Too many failed attempts. Access blocked for {minutes} minutes.";
                    Logger.LogWarning("IP {IP} banned after {Attempts} failed login attempts", clientIp, attempts);
                }
                else
                {
                    var remaining = 3 - attempts;
                    errorMessage = error ?? "Login failed";
                    if (remaining > 0 && remaining < 3)
                    {
                        errorMessage += $" ({remaining} attempt{(remaining == 1 ? "" : "s")} remaining)";
                    }
                }
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error during login");
            errorMessage = "An unexpected error occurred";
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetClientIp()
    {
        var context = HttpContextAccessor.HttpContext;
        if (context == null) return "unknown";

        // Check for forwarded IP (behind reverse proxy)
        var forwardedFor = context.Request.Headers["X-Forwarded-For"].FirstOrDefault();
        if (!string.IsNullOrEmpty(forwardedFor))
        {
            var ip = forwardedFor.Split(',').First().Trim();
            if (!string.IsNullOrEmpty(ip)) return ip;
        }

        return context.Connection.RemoteIpAddress?.ToString() ?? "unknown";
    }
}
