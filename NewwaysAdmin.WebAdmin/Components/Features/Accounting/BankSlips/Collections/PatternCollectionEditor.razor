@* NewwaysAdmin.WebAdmin/Components/Features/Accounting/BankSlips/Collections/PatternCollectionEditor.razor *@
@using NewwaysAdmin.SharedModels.BankSlips
@using NewwaysAdmin.SharedModels.Services.Ocr
@using Microsoft.Extensions.Logging
@inject PatternManagementService PatternService
@inject ILogger<PatternCollectionEditor> Logger

@if (IsVisible)
{
    <div class="modal fade show" style="display: block;" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-collection me-2"></i>
                        @(IsEditMode ? "Edit" : "Create") Bank Slip Collection
                    </h5>
                    <button type="button" class="btn-close" @onclick="HandleCancel"></button>
                </div>

                <EditForm Model="Collection" OnValidSubmit="HandleSave">
                    <DataAnnotationsValidator />

                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(_errorMessage))
                        {
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle me-2"></i>@_errorMessage
                            </div>
                        }

                        @* Basic Information *@
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-info-circle me-2"></i>Collection Information
                            </h6>

                            <div class="row">
                                <div class="col-md-8">
                                    <label class="form-label">Collection Name *</label>
                                    <InputText @bind-Value="Collection.Name"
                                               class="form-control"
                                               placeholder="e.g., My KBIZ Bank Slips" />
                                    <ValidationMessage For="@(() => Collection.Name)" />
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Status</label>
                                    <InputSelect @bind-Value="Collection.IsActive" class="form-select">
                                        <option value="true">Active</option>
                                        <option value="false">Inactive</option>
                                    </InputSelect>
                                </div>
                            </div>

                            <div class="mt-3">
                                <label class="form-label">Description</label>
                                <InputTextArea class="form-control"
                                               rows="2"
                                               @bind-Value="Collection.Description"
                                               placeholder="Optional description" />
                                <ValidationMessage For="@(() => Collection.Description)" />
                            </div>
                        </div>

                        @* Pattern Configuration *@
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-gear me-2"></i>Pattern Configuration
                            </h6>

                            @* Document Type (Fixed for BankSlips) *@
                            <div class="mb-3">
                                <label class="form-label">Document Type</label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-bank me-1"></i>
                                    </span>
                                    <input type="text" class="form-control" value="BankSlips" readonly />
                                </div>
                                <small class="text-muted">Document type is fixed for this page</small>
                            </div>

                            @* Format Selection - FIXED: Removed conflicting @onchange *@
                            <div class="mb-3">
                                <label for="formatSelect" class="form-label">
                                    Format *
                                    @if (_isLoadingFormats)
                                    {
                                        <span class="spinner-border spinner-border-sm ms-2"></span>
                                    }
                                    <button type="button" class="btn btn-outline-secondary btn-sm ms-2"
                                            @onclick="RefreshFormats" title="Refresh formats">
                                        <i class="bi bi-arrow-clockwise"></i>
                                    </button>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="bi bi-tags me-1"></i>
                                    </span>
                                    <InputSelect id="formatSelect"
                                                 class="form-select"
                                                 @bind-Value="Collection.FormatName">
                                        <option value="">Select a format...</option>
                                        @foreach (var format in _availableFormats)
                                        {
                                            <option value="@format">@format</option>
                                        }
                                    </InputSelect>
                                </div>
                                <ValidationMessage For="@(() => Collection.FormatName)" />

                                @if (_isLoadingFormats)
                                {
                                    <small class="text-muted">
                                        <span class="spinner-border spinner-border-sm me-1"></span>
                                        Loading available formats...
                                    </small>
                                }
                                else if (!_availableFormats.Any())
                                {
                                    <div class="alert alert-warning mt-2">
                                        <i class="bi bi-exclamation-triangle me-2"></i>
                                        <strong>No formats available!</strong>
                                        Please create patterns first using Settings → OCR Analyzer.
                                        <div class="mt-2">
                                            <a href="/settings/ocr-analyzer" class="btn btn-sm btn-outline-primary">
                                                <i class="bi bi-gear"></i> Go to OCR Settings
                                            </a>
                                        </div>
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(Collection.FormatName) && _formatPatterns.ContainsKey(Collection.FormatName))
                                {
                                    <small class="text-success">
                                        <i class="bi bi-check-circle me-1"></i>
                                        Found @_formatPatterns[Collection.FormatName].Count patterns:
                                        @string.Join(", ", _formatPatterns[Collection.FormatName])
                                    </small>
                                }
                            </div>
                        </div>

                        @* Directory Configuration *@
                        <div class="mb-4">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-folder me-2"></i>Directory Configuration
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">Source Directory *</label>
                                    <InputText @bind-Value="Collection.SourceDirectory"
                                               class="form-control"
                                               placeholder="C:\BankSlips\Input" />
                                    <ValidationMessage For="@(() => Collection.SourceDirectory)" />
                                    <small class="text-muted">Where your bank slip images are stored</small>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Output Directory *</label>
                                    <InputText @bind-Value="Collection.OutputDirectory"
                                               class="form-control"
                                               placeholder="C:\BankSlips\Processed" />
                                    <ValidationMessage For="@(() => Collection.OutputDirectory)" />
                                    <small class="text-muted">Where processed results will be saved</small>
                                </div>
                            </div>
                        </div>

                        @* Advanced Settings *@
                        <div class="mb-3">
                            <h6 class="fw-bold mb-3">
                                <i class="bi bi-sliders me-2"></i>Processing Settings
                            </h6>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="Collection.ProcessingSettings.UseEnhancedDateValidation"
                                                       id="enhancedDate" />
                                        <label class="form-check-label" for="enhancedDate">
                                            Enhanced date validation
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="Collection.ProcessingSettings.ExtractDualLanguageNames"
                                                       id="dualLanguage" />
                                        <label class="form-check-label" for="dualLanguage">
                                            Extract dual language names
                                        </label>
                                    </div>
                                </div>
                            </div>

                            <div class="row mt-2">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="Collection.ProcessingSettings.EnablePatternDebugging"
                                                       id="patternDebug" />
                                        <label class="form-check-label" for="patternDebug">
                                            Enable pattern debugging
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <InputCheckbox class="form-check-input"
                                                       @bind-Value="Collection.ProcessingSettings.UseAdvancedPatternMatching"
                                                       id="advancedPatterns" />
                                        <label class="form-check-label" for="advancedPatterns">
                                            Advanced pattern matching
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @* Credentials Path *@
                        <div class="mb-3">
                            <label class="form-label">Google Cloud Credentials</label>
                            <InputText @bind-Value="Collection.CredentialsPath"
                                       class="form-control"
                                       placeholder="C:\Keys\credentials.json" />
                            <small class="text-muted">Path to Google Cloud Vision API credentials file</small>
                        </div>
                    </div>

                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="HandleCancel">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary" disabled="@(!CanSave())">
                            @if (_isSaving)
                            {
                                <span class="spinner-border spinner-border-sm me-2"></span>
                            }
                            <i class="bi bi-floppy me-1"></i>
                            @(IsEditMode ? "Update" : "Create") Collection
                        </button>
                    </div>
                </EditForm>
            </div>
        </div>
    </div>

    @* Modal Backdrop *@
    <div class="modal-backdrop fade show"></div>
}

@code {
    [Parameter] public SlipCollection Collection { get; set; } = new();
    [Parameter] public bool IsVisible { get; set; }
    [Parameter] public bool IsEditMode { get; set; }
    [Parameter] public EventCallback<SlipCollection> OnSave { get; set; }
    [Parameter] public EventCallback OnCancel { get; set; }

    private List<string> _availableFormats = new();
    private Dictionary<string, List<string>> _formatPatterns = new();
    private bool _isLoadingFormats = false;
    private bool _isSaving = false;
    private string _errorMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        Logger.LogDebug("PatternCollectionEditor initializing...");
        await LoadAvailableFormats();
    }

    protected override async Task OnParametersSetAsync()
    {
        // Ensure DocumentType is always set for BankSlips
        if (Collection != null)
        {
            Collection.DocumentType = "BankSlips";
            Logger.LogDebug("Set DocumentType to BankSlips for collection {Name}", Collection.Name);
        }

        // Refresh formats when modal opens
        if (IsVisible && !_availableFormats.Any())
        {
            Logger.LogDebug("Modal opened and no formats loaded, refreshing...");
            await LoadAvailableFormats();
        }
    }

    private async Task LoadAvailableFormats()
    {
        try
        {
            _isLoadingFormats = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            Logger.LogDebug("Loading available formats for BankSlips...");

            var subCollections = await PatternService.GetSubCollectionNamesAsync("BankSlips");
            _availableFormats = subCollections ?? new List<string>();

            Logger.LogDebug("Found {Count} available formats: {Formats}",
                _availableFormats.Count, string.Join(", ", _availableFormats));

            // Load pattern previews for each format
            _formatPatterns.Clear();
            foreach (var format in _availableFormats)
            {
                try
                {
                    var patterns = await LoadPatternsAsync("BankSlips", format);
                    _formatPatterns[format] = patterns;
                    Logger.LogDebug("Loaded {Count} patterns for format {Format}", patterns.Count, format);
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Error loading patterns for format {Format}", format);
                    _formatPatterns[format] = new List<string>();
                }
            }

            Logger.LogDebug("Loaded pattern previews for {Count} formats", _formatPatterns.Count);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error loading available formats");
            _errorMessage = $"Error loading formats: {ex.Message}";
            _availableFormats = new List<string>();
        }
        finally
        {
            _isLoadingFormats = false;
            StateHasChanged();
        }
    }

    private async Task<List<string>> LoadPatternsAsync(string documentType, string format)
    {
        try
        {
            var patternNames = await PatternService.GetSearchPatternNamesAsync(documentType, format);
            return patternNames ?? new List<string>();
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Error loading patterns for {DocumentType}/{Format}", documentType, format);
            return new List<string>();
        }
    }

    private async Task RefreshFormats()
    {
        Logger.LogInformation("Manually refreshing available formats...");
        await LoadAvailableFormats();
    }

    private bool CanSave()
    {
        var canSave = !string.IsNullOrWhiteSpace(Collection?.Name) &&
               !string.IsNullOrWhiteSpace(Collection?.FormatName) &&
               !string.IsNullOrWhiteSpace(Collection?.SourceDirectory) &&
               !string.IsNullOrWhiteSpace(Collection?.OutputDirectory) &&
               !_isSaving;

        Logger.LogDebug("CanSave: {CanSave} (Name: {HasName}, Format: {HasFormat}, Source: {HasSource}, Output: {HasOutput}, Saving: {IsSaving})",
            canSave,
            !string.IsNullOrWhiteSpace(Collection?.Name),
            !string.IsNullOrWhiteSpace(Collection?.FormatName),
            !string.IsNullOrWhiteSpace(Collection?.SourceDirectory),
            !string.IsNullOrWhiteSpace(Collection?.OutputDirectory),
            _isSaving);

        return canSave;
    }

    private async Task HandleSave()
    {
        try
        {
            _isSaving = true;
            _errorMessage = string.Empty;
            StateHasChanged();

            Logger.LogInformation("Saving collection {CollectionName} with format {Format}...",
                Collection.Name, Collection.FormatName);

            // Validate that patterns exist for the selected format
            if (!await PatternService.HasPatternsAsync("BankSlips", Collection.FormatName))
            {
                _errorMessage = $"No patterns found for format '{Collection.FormatName}'. Please create patterns first using OCR Analyzer.";
                Logger.LogWarning("Attempted to save collection with non-existent format: {Format}", Collection.FormatName);
                return;
            }

            // Ensure pattern-based properties are set
            Collection.DocumentType = "BankSlips";

            // Auto-configure processing settings based on format
            if (Collection.ProcessingSettings == null)
            {
                Collection.ProcessingSettings = new ProcessingParameters();
            }

            // Set format-specific defaults
            if (Collection.FormatName?.Contains("KBIZ", StringComparison.OrdinalIgnoreCase) == true)
            {
                Collection.ProcessingSettings.ExtractDualLanguageNames = true;
                Collection.ProcessingSettings.UseEnhancedDateValidation = true;
                Collection.IsKBizFormat = true; // Maintain backward compatibility
                Logger.LogDebug("Configured KBIZ-specific settings for collection");
            }
            else
            {
                Collection.IsKBizFormat = false;
            }

            Logger.LogInformation("Saving collection {CollectionName} with format {Format}",
                Collection.Name, Collection.FormatName);

            await OnSave.InvokeAsync(Collection);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error saving collection {CollectionName}", Collection?.Name);
            _errorMessage = $"Error saving collection: {ex.Message}";
        }
        finally
        {
            _isSaving = false;
            StateHasChanged();
        }
    }

    private async Task HandleCancel()
    {
        _errorMessage = string.Empty;
        await OnCancel.InvokeAsync();
    }
}