@* File: NewwaysAdmin.WebAdmin/Components/Features/Accounting/CategoryManagement/PersonManager.razor *@
@using NewwaysAdmin.SharedModels.Categories
@using NewwaysAdmin.WebAdmin.Services.Categories
@inject CategoryService CategoryService
@inject IJSRuntime JSRuntime

<div class="card mb-3">
    <div class="card-header">
        <h6 class="mb-0">
            <i class="fas fa-user me-2"></i>Responsible Persons
        </h6>
    </div>
    <div class="card-body">
        @if (isLoading)
        {
            <div class="text-center">
                <div class="spinner-border spinner-border-sm" role="status"></div>
            </div>
        }
        else
        {
            @if (persons?.Any() == true)
            {
                <div class="mb-3">
                    @foreach (var person in persons.OrderBy(p => p.SortOrder))
                    {
                        <div class="d-flex align-items-center justify-content-between mb-2">
                            <span class="badge bg-info">
                                <i class="fas fa-user me-1"></i>@person.Name
                            </span>
                            <button class="btn btn-sm btn-outline-danger"
                                    @onclick="() => DeletePerson(person)"
                                    title="Delete person">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    }
                </div>
            }

            <div class="input-group">
                <input type="text" class="form-control" @bind="newPersonName" @onkeypress="HandleKeyPress"
                       placeholder="Add new person..." maxlength="50" />
                <button class="btn btn-outline-info" @onclick="AddPerson" disabled="@(string.IsNullOrWhiteSpace(newPersonName))">
                    <i class="fas fa-plus"></i>
                </button>
            </div>

            @if (!string.IsNullOrWhiteSpace(errorMessage))
            {
                <small class="text-danger">@errorMessage</small>
            }

            <small class="form-text text-muted mt-2">
                Persons are selected when using categories in the mobile app to track who made the payment.
            </small>
        }
    </div>
</div>

@code {
    [Parameter] public EventCallback OnPersonUpdate { get; set; }

    private List<ResponsiblePerson>? persons;
    private string newPersonName = "";
    private string errorMessage = "";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadPersons();
    }

    private async Task LoadPersons()
    {
        try
        {
            isLoading = true;
            var data = await CategoryService.GetFullDataAsync();
            persons = data.Persons;
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading persons: {ex.Message}";
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await AddPerson();
        }
    }

    private async Task AddPerson()
    {
        errorMessage = "";

        if (string.IsNullOrWhiteSpace(newPersonName))
        {
            errorMessage = "Person name is required";
            return;
        }

        var trimmedName = newPersonName.Trim();

        if (persons?.Any(p => p.Name.Equals(trimmedName, StringComparison.OrdinalIgnoreCase)) == true)
        {
            errorMessage = "This person already exists";
            return;
        }

        if (trimmedName.Length < 2)
        {
            errorMessage = "Person name must be at least 2 characters";
            return;
        }

        try
        {
            await CategoryService.AddPersonAsync(trimmedName, "Admin");
            newPersonName = "";
            await LoadPersons();
            await OnPersonUpdate.InvokeAsync();
            await JSRuntime.InvokeVoidAsync("showToast", $"Person '{trimmedName}' added!", "success");
        }
        catch (Exception ex)
        {
            errorMessage = $"Error adding person: {ex.Message}";
        }
    }

    private async Task DeletePerson(ResponsiblePerson person)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm",
            $"Are you sure you want to delete '{person.Name}'?");

        if (confirmed)
        {
            try
            {
                await CategoryService.DeletePersonAsync(person.Id);
                await LoadPersons();
                await OnPersonUpdate.InvokeAsync();
                await JSRuntime.InvokeVoidAsync("showToast", $"Person '{person.Name}' deleted!", "success");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("showToast", $"Error: {ex.Message}", "danger");
            }
        }
    }
}