@* File: NewwaysAdmin.WebAdmin/Components/Features/Accounting/BankSlipProjects/Modals/ExportModal.razor *@
@namespace NewwaysAdmin.WebAdmin.Components.Features.Accounting.BankSlipProjects.Modals
@using NewwaysAdmin.SharedModels.BankSlips

@if (isVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-excel me-2"></i>Export Bank Slips
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>

                <div class="modal-body">
                    @* Date Range *@
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" @bind="dateFrom" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" @bind="dateTo" />
                        </div>
                    </div>

                    @* Include Options *@
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-toggles me-1"></i>Include Columns
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incVat" @bind="includeVat" />
                                        <label class="form-check-label" for="incVat">VAT</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incBill" @bind="includeBill" />
                                        <label class="form-check-label" for="incBill">Has Bill</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incPrivate" @bind="includePrivate" />
                                        <label class="form-check-label" for="incPrivate">Private</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incLocation" @bind="includeLocation" />
                                        <label class="form-check-label" for="incLocation">Location</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incPerson" @bind="includePerson" />
                                        <label class="form-check-label" for="incPerson">Person</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Category Selection *@
                    <div class="card">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-tag me-1"></i>Categories</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" @onclick="SelectAllCategories">Select All</button>
                                <button class="btn btn-outline-secondary" @onclick="SelectNoneCategories">None</button>
                            </div>
                        </div>
                        <div class="card-body py-2" style="max-height: 300px; overflow-y: auto;">
                            @if (categorySelections.Count == 0)
                            {
                                <div class="text-muted">No categories found in projects.</div>
                            }
                            else
                            {
                                @foreach (var cat in categorySelections)
                                {
                                    var catId = GetSafeId(cat.Name);
                                    <div class="border-bottom py-1">
                                        <div class="d-flex align-items-center">
                                            @* Expand/Collapse button *@
                                            @if (cat.SubCategories.Count > 0)
                                            {
                                                <button class="btn btn-sm btn-link p-0 me-1" @onclick="@(() => ToggleCategory(cat))">
                                                    <i class="bi @(cat.IsExpanded ? "bi-chevron-down" : "bi-chevron-right")"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="me-3"></span>
                                            }

                                            @* Category name and count *@
                                            <span class="flex-grow-1">
                                                @cat.Name
                                                <span class="badge bg-secondary ms-1">@cat.ProjectCount</span>
                                            </span>

                                            @* Category checkbox *@
                                            <div class="form-check form-check-inline m-0">
                                                <input type="checkbox" class="form-check-input"
                                                       id="@catId"
                                                       checked="@cat.IsSelected"
                                                       @onchange="@(e => ToggleCategorySelection(cat, (bool?)e.Value ?? false))" />
                                            </div>
                                        </div>

                                        @* Sub-categories (when expanded) *@
                                        @if (cat.IsExpanded && cat.SubCategories.Count > 0)
                                        {
                                            <div class="ms-4 mt-1">
                                                @foreach (var sub in cat.SubCategories)
                                                {
                                                    var subId = GetSafeId(cat.Name + "_" + sub.Name);
                                                    <div class="d-flex align-items-center py-1">
                                                        <span class="text-muted me-2">└─</span>
                                                        <span class="flex-grow-1">
                                                            @sub.Name
                                                            <span class="badge bg-light text-dark ms-1">@sub.ProjectCount</span>
                                                        </span>
                                                        <div class="form-check form-check-inline m-0">
                                                            <input type="checkbox" class="form-check-input"
                                                                   id="@subId"
                                                                   checked="@sub.IsSelected"
                                                                   @onchange="@(e => sub.IsSelected = (bool?)e.Value ?? false)" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @* Preview stats *@
                    <div class="alert alert-info mt-3 mb-0 py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>@GetSelectedProjectCount()</strong> transactions will be exported
                        (Total: <strong>@GetSelectedTotal().ToString("N0") ฿</strong>)
                    </div>

                    @* Error message *@
                    @if (!string.IsNullOrEmpty(exportError))
                    {
                        <div class="alert alert-danger mt-2 mb-0 py-2">
                            <i class="bi bi-exclamation-triangle me-1"></i>@exportError
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" @onclick="ExportAsync" disabled="@isExporting">
                        @if (isExporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                            <span>Generating...</span>
                        }
                        else
                        {
                            <i class="bi bi-download me-1"></i>
                            <span>Export Excel</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    </div>
}
