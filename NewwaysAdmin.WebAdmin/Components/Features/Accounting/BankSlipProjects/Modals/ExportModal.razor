@* File: NewwaysAdmin.WebAdmin/Components/Features/Accounting/BankSlipProjects/Modals/ExportModal.razor *@
@using NewwaysAdmin.SharedModels.BankSlips
@inject IJSRuntime JS
@inject ILogger<ExportModal> Logger

@if (isVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-file-earmark-excel me-2"></i>Export Bank Slips
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>

                <div class="modal-body">
                    @* Date Range *@
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">From Date</label>
                            <input type="date" class="form-control" @bind="dateFrom" />
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">To Date</label>
                            <input type="date" class="form-control" @bind="dateTo" />
                        </div>
                    </div>

                    @* Include Options *@
                    <div class="card mb-3">
                        <div class="card-header py-2">
                            <i class="bi bi-toggles me-1"></i>Include Columns
                        </div>
                        <div class="card-body py-2">
                            <div class="row g-2">
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incVat" @bind="includeVat" />
                                        <label class="form-check-label" for="incVat">VAT</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incBill" @bind="includeBill" />
                                        <label class="form-check-label" for="incBill">Has Bill</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incPrivate" @bind="includePrivate" />
                                        <label class="form-check-label" for="incPrivate">Private</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incLocation" @bind="includeLocation" />
                                        <label class="form-check-label" for="incLocation">Location</label>
                                    </div>
                                </div>
                                <div class="col-auto">
                                    <div class="form-check">
                                        <input type="checkbox" class="form-check-input" id="incPerson" @bind="includePerson" />
                                        <label class="form-check-label" for="incPerson">Person</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    @* Category Selection *@
                    <div class="card">
                        <div class="card-header py-2 d-flex justify-content-between align-items-center">
                            <span><i class="bi bi-tag me-1"></i>Categories</span>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-primary" @onclick="SelectAllCategories">Select All</button>
                                <button class="btn btn-outline-secondary" @onclick="SelectNoneCategories">None</button>
                            </div>
                        </div>
                        <div class="card-body py-2" style="max-height: 300px; overflow-y: auto;">
                            @if (categorySelections.Count == 0)
                            {
                                <div class="text-muted">No categories found in projects.</div>
                            }
                            else
                            {
                                @foreach (var cat in categorySelections)
                                {
                                    var catId = GetSafeId(cat.Name);
                                    <div class="border-bottom py-1">
                                        <div class="d-flex align-items-center">
                                            @* Expand/Collapse button *@
                                            @if (cat.SubCategories.Count > 0)
                                            {
                                                <button class="btn btn-sm btn-link p-0 me-1" @onclick="@(() => ToggleCategory(cat))">
                                                    <i class="bi @(cat.IsExpanded ? "bi-chevron-down" : "bi-chevron-right")"></i>
                                                </button>
                                            }
                                            else
                                            {
                                                <span class="me-3"></span>
                                            }

                                            @* Category name and count *@
                                            <span class="flex-grow-1">
                                                @cat.Name
                                                <span class="badge bg-secondary ms-1">@cat.ProjectCount</span>
                                            </span>

                                            @* Category checkbox *@
                                            <div class="form-check form-check-inline m-0">
                                                <input type="checkbox" class="form-check-input"
                                                       id="@catId"
                                                       checked="@cat.IsSelected"
                                                       @onchange="@(e => ToggleCategorySelection(cat, (bool?)e.Value ?? false))" />
                                            </div>
                                        </div>

                                        @* Sub-categories (when expanded) *@
                                        @if (cat.IsExpanded && cat.SubCategories.Count > 0)
                                        {
                                            <div class="ms-4 mt-1">
                                                @foreach (var sub in cat.SubCategories)
                                                {
                                                    var subId = GetSafeId(cat.Name + "_" + sub.Name);
                                                    <div class="d-flex align-items-center py-1">
                                                        <span class="text-muted me-2">└─</span>
                                                        <span class="flex-grow-1">
                                                            @sub.Name
                                                            <span class="badge bg-light text-dark ms-1">@sub.ProjectCount</span>
                                                        </span>
                                                        <div class="form-check form-check-inline m-0">
                                                            <input type="checkbox" class="form-check-input"
                                                                   id="@subId"
                                                                   checked="@sub.IsSelected"
                                                                   @onchange="@(e => sub.IsSelected = (bool?)e.Value ?? false)" />
                                                        </div>
                                                    </div>
                                                }
                                            </div>
                                        }
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    @* Preview stats *@
                    <div class="alert alert-info mt-3 mb-0 py-2">
                        <i class="bi bi-info-circle me-1"></i>
                        <strong>@GetSelectedProjectCount()</strong> transactions will be exported
                        (Total: <strong>@GetSelectedTotal().ToString("N0") ฿</strong>)
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="Close">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-success" @onclick="ExportAsync" disabled="@isExporting">
                        @if (isExporting)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-download me-1"></i>Export Excel
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public List<BankSlipProject> Projects { get; set; } = new();
    [Parameter] public List<CategoryInfo> AvailableCategories { get; set; } = new();

    private bool isVisible = false;
    private bool isExporting = false;

    // Date range
    private DateTime? dateFrom;
    private DateTime? dateTo;

    // Include options
    private bool includeVat = true;
    private bool includeBill = true;
    private bool includePrivate = false;
    private bool includeLocation = false;
    private bool includePerson = false;

    // Category selections
    private List<CategorySelection> categorySelections = new();

    public Task OpenAsync(DateTime? defaultDateFrom, DateTime? defaultDateTo)
    {
        dateFrom = defaultDateFrom;
        dateTo = defaultDateTo;

        BuildCategorySelections();

        isVisible = true;
        StateHasChanged();

        return Task.CompletedTask;
    }

    private string GetSafeId(string name)
    {
        // Create a safe HTML id from a name
        return "cat_" + name.Replace(" ", "_").Replace("(", "").Replace(")", "");
    }

    private void BuildCategorySelections()
    {
        categorySelections.Clear();

        // Get projects in date range
        var projectsInRange = GetFilteredProjects();

        // Group by category
        var categoryGroups = projectsInRange
            .Where(p => p.StructuredMemo?.CategoryName != null)
            .GroupBy(p => p.StructuredMemo!.CategoryName!)
            .ToDictionary(g => g.Key, g => g.ToList());

        foreach (var catInfo in AvailableCategories.OrderBy(c => c.Name))
        {
            var projectsInCat = categoryGroups.ContainsKey(catInfo.Name)
                ? categoryGroups[catInfo.Name]
                : new List<BankSlipProject>();

            var selection = new CategorySelection
                {
                    Name = catInfo.Name,
                    IsSelected = true,
                    IsExpanded = false,
                    ProjectCount = projectsInCat.Count
                };

            // Add subcategories
            foreach (var subName in catInfo.SubCategories)
            {
                var subCount = projectsInCat.Count(p => p.StructuredMemo?.SubCategoryName == subName);
                selection.SubCategories.Add(new SubCategorySelection
                    {
                        Name = subName,
                        IsSelected = true,
                        ProjectCount = subCount
                    });
            }

            categorySelections.Add(selection);
        }

        // Add uncategorized if any
        var uncategorizedCount = projectsInRange.Count(p =>
            p.StructuredMemo == null || string.IsNullOrEmpty(p.StructuredMemo.CategoryName));

        if (uncategorizedCount > 0)
        {
            categorySelections.Add(new CategorySelection
                {
                    Name = "(Uncategorized)",
                    IsSelected = true,
                    IsExpanded = false,
                    ProjectCount = uncategorizedCount
                });
        }
    }

    private List<BankSlipProject> GetFilteredProjects()
    {
        var query = Projects.AsEnumerable();

        if (dateFrom.HasValue)
            query = query.Where(p => p.TransactionTimestamp.Date >= dateFrom.Value.Date);

        if (dateTo.HasValue)
            query = query.Where(p => p.TransactionTimestamp.Date <= dateTo.Value.Date);

        if (!includePrivate)
            query = query.Where(p => !p.IsPrivate);

        return query.ToList();
    }

    private void ToggleCategory(CategorySelection cat)
    {
        cat.IsExpanded = !cat.IsExpanded;
    }

    private void ToggleCategorySelection(CategorySelection cat, bool selected)
    {
        cat.IsSelected = selected;
        // Also toggle all subcategories
        foreach (var sub in cat.SubCategories)
        {
            sub.IsSelected = selected;
        }
    }

    private void SelectAllCategories()
    {
        foreach (var cat in categorySelections)
        {
            cat.IsSelected = true;
            foreach (var sub in cat.SubCategories)
            {
                sub.IsSelected = true;
            }
        }
    }

    private void SelectNoneCategories()
    {
        foreach (var cat in categorySelections)
        {
            cat.IsSelected = false;
            foreach (var sub in cat.SubCategories)
            {
                sub.IsSelected = false;
            }
        }
    }

    private int GetSelectedProjectCount()
    {
        return GetProjectsForExport().Count;
    }

    private decimal GetSelectedTotal()
    {
        return GetProjectsForExport().Sum(p => ParseAmount(p.GetTotal()));
    }

    private List<BankSlipProject> GetProjectsForExport()
    {
        var selectedCategories = categorySelections
            .Where(c => c.IsSelected)
            .Select(c => c.Name)
            .ToHashSet();

        var selectedSubCategories = categorySelections
            .SelectMany(c => c.SubCategories.Where(s => s.IsSelected).Select(s => (c.Name, s.Name)))
            .ToHashSet();

        return GetFilteredProjects()
            .Where(p =>
            {
                var catName = p.StructuredMemo?.CategoryName ?? "(Uncategorized)";
                var subName = p.StructuredMemo?.SubCategoryName;

                // Must have category selected
                if (!selectedCategories.Contains(catName))
                    return false;

                // If has subcategory, it must be selected
                if (!string.IsNullOrEmpty(subName))
                {
                    return selectedSubCategories.Contains((catName, subName));
                }

                return true;
            })
            .ToList();
    }

    private decimal ParseAmount(string amountStr)
    {
        if (string.IsNullOrWhiteSpace(amountStr)) return 0;
        var cleaned = amountStr.Replace(",", "").Replace("฿", "").Replace("THB", "").Trim();
        return decimal.TryParse(cleaned, out var amount) ? amount : 0;
    }

    private void Close()
    {
        isVisible = false;
        StateHasChanged();
    }

    private async Task ExportAsync()
    {
        isExporting = true;
        StateHasChanged();

        try
        {
            var projectsToExport = GetProjectsForExport();
            var selectedCategoryNames = categorySelections
                .Where(c => c.IsSelected)
                .Select(c => c.Name)
                .ToList();

            // Build export options
            var options = new ExportOptions
                {
                    DateFrom = dateFrom,
                    DateTo = dateTo,
                    IncludeVat = includeVat,
                    IncludeBill = includeBill,
                    IncludePrivate = includePrivate,
                    IncludeLocation = includeLocation,
                    IncludePerson = includePerson,
                    SelectedCategoryNames = selectedCategoryNames
                };

            // TODO: Call export service and download file
            Logger.LogInformation("Exporting {Count} projects with {CatCount} categories",
                projectsToExport.Count, selectedCategoryNames.Count);

            // For now, just log
            await Task.Delay(500); // Simulate export

            Close();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error exporting");
        }
        finally
        {
            isExporting = false;
            StateHasChanged();
        }
    }

    // Helper classes - PUBLIC for accessibility
    public class CategorySelection
    {
        public string Name { get; set; } = "";
        public bool IsSelected { get; set; } = true;
        public bool IsExpanded { get; set; } = false;
        public int ProjectCount { get; set; }
        public List<SubCategorySelection> SubCategories { get; set; } = new();
    }

    public class SubCategorySelection
    {
        public string Name { get; set; } = "";
        public bool IsSelected { get; set; } = true;
        public int ProjectCount { get; set; }
    }

    public class ExportOptions
    {
        public DateTime? DateFrom { get; set; }
        public DateTime? DateTo { get; set; }
        public bool IncludeVat { get; set; }
        public bool IncludeBill { get; set; }
        public bool IncludePrivate { get; set; }
        public bool IncludeLocation { get; set; }
        public bool IncludePerson { get; set; }
        public List<string> SelectedCategoryNames { get; set; } = new();
    }
}
