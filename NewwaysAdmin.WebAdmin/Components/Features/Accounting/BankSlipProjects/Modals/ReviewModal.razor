@* File: NewwaysAdmin.WebAdmin/Components/Features/Accounting/BankSlipProjects/Modals/ReviewModal.razor *@
@namespace NewwaysAdmin.WebAdmin.Components.Features.Accounting.BankSlipProjects.Modals
@using NewwaysAdmin.WebAdmin.Components.Features.Accounting.BankSlipProjects.Components
@using NewwaysAdmin.SharedModels.BankSlips

@if (isVisible)
{
    <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
        <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-pencil-square me-2"></i>Review Project
                    </h5>
                    <button type="button" class="btn-close btn-close-white" @onclick="Close"></button>
                </div>

                <div class="modal-body">
                    @if (project == null)
                    {
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary"></div>
                        </div>
                    }
                    else
                    {
                        <div class="row">
                            @* Left column: Image preview *@
                            <div class="col-md-4">
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Bank Slip</small>
                                    </div>
                                    <div class="card-body text-center p-2">
                                        @if (isLoadingImage)
                                        {
                                            <div class="bg-light rounded p-4">
                                                <div class="spinner-border spinner-border-sm text-primary"></div>
                                            </div>
                                        }
                                        else if (!string.IsNullOrEmpty(imagePreviewUrl))
                                        {
                                            <img src="@imagePreviewUrl"
                                                 class="img-fluid rounded cursor-pointer"
                                                 style="max-height: 200px; cursor: pointer;"
                                                 alt="Bank Slip"
                                                 @onclick="ViewFullImage"
                                                 title="Click to view full size" />
                                        }
                                        else
                                        {
                                            <div class="bg-light rounded p-4">
                                                <i class="bi bi-image display-6 text-muted"></i>
                                                <p class="text-muted small mt-2 mb-0">No preview</p>
                                            </div>
                                        }
                                        <button class="btn btn-sm btn-outline-primary mt-2 w-100" @onclick="ViewFullImage">
                                            <i class="bi bi-arrows-fullscreen me-1"></i>View Full
                                        </button>
                                    </div>
                                </div>

                                @* Transaction info card *@
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Transaction</small>
                                    </div>
                                    <div class="card-body small">
                                        <div class="mb-2">
                                            <span class="text-muted">Amount:</span>
                                            <strong class="text-success float-end">@project.GetTotal() ฿</strong>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">Date:</span>
                                            <span class="float-end">@project.TransactionTimestamp.ToString("dd/MM/yyyy HH:mm")</span>
                                        </div>
                                        <div class="mb-2">
                                            <span class="text-muted">User:</span>
                                            <span class="float-end">@project.Username</span>
                                        </div>
                                        <div class="mb-0">
                                            <span class="text-muted">Bank:</span>
                                            <span class="float-end badge bg-secondary">@project.PatternSetName</span>
                                        </div>
                                        @if (project.ExtractedFields.TryGetValue("_FallbackPattern", out var fallbackPattern))
                                        {
                                            <div class="mt-2">
                                                <span class="text-muted">Used:</span>
                                                <span class="float-end badge bg-warning text-dark">@fallbackPattern</span>
                                            </div>
                                        }
                                        @if (!string.IsNullOrEmpty(project.ProcessingError))
                                        {
                                            <div class="mt-2 text-danger small">
                                                <i class="bi bi-exclamation-triangle me-1"></i>@project.ProcessingError
                                            </div>
                                        }
                                    </div>
                                </div>

                                @* Bills section *@
                                <div class="card">
                                    <div class="card-header py-2 d-flex justify-content-between align-items-center">
                                        <small class="fw-bold">Bills/Receipts</small>
                                        <div class="form-check form-check-inline mb-0">
                                            <input type="checkbox" class="form-check-input" id="hasBill"
                                                   @bind="editHasBill" />
                                            <label class="form-check-label small" for="hasBill">Has bill</label>
                                        </div>
                                    </div>
                                    <div class="card-body small">
                                        <BillUploadPanel ProjectId="@project.ProjectId"
                                                         BillReferences="@project.BillFileReferences"
                                                         BillReferencesChanged="OnBillReferencesChanged"
                                                         OnHasBillChanged="OnHasBillChanged" />
                                    </div>
                                </div>
                            </div>

                            @* Right column: Edit form *@
                            <div class="col-md-8">
                                @* Recipient info *@
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Recipient</small>
                                    </div>
                                    <div class="card-body">
                                        <p class="mb-0 small" style="word-break: break-word;">
                                            @project.GetRecipient()
                                        </p>
                                    </div>
                                </div>

                                @* Category info *@
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Categorization</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-2">
                                            @* Location *@
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">Location</label>
                                                <select class="form-select form-select-sm"
                                                        value="@editLocation"
                                                        @onchange="OnLocationChanged">
                                                    <option value="">-- No Location --</option>
                                                    @foreach (var loc in locations)
                                                    {
                                                        <option value="@loc.Name">@loc.Name</option>
                                                    }
                                                </select>
                                            </div>

                                            @* Person *@
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">Person</label>
                                                <select class="form-select form-select-sm"
                                                        value="@editPerson"
                                                        @onchange="OnPersonChanged">
                                                    <option value="">-- No Person --</option>
                                                    @foreach (var person in persons)
                                                    {
                                                        <option value="@person.Name">@person.Name</option>
                                                    }
                                                </select>
                                            </div>

                                            @* Category *@
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">Category</label>
                                                <select class="form-select form-select-sm"
                                                        value="@editCategory"
                                                        @onchange="OnCategoryChanged">
                                                    <option value="">-- Select Category --</option>
                                                    @foreach (var cat in categories)
                                                    {
                                                        <option value="@cat.Name">@cat.Name</option>
                                                    }
                                                </select>
                                            </div>

                                            @* SubCategory *@
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">SubCategory</label>
                                                <select class="form-select form-select-sm"
                                                        value="@editSubCategory"
                                                        @onchange="OnSubCategoryChanged"
                                                        disabled="@(!subCategories.Any())">
                                                    <option value="">-- Select SubCategory --</option>
                                                    @foreach (var sub in subCategories)
                                                    {
                                                        <option value="@sub">@sub</option>
                                                    }
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @* VAT & Privacy *@
                                <div class="card mb-3">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Options</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-2">
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">VAT Status</label>
                                                <select class="form-select form-select-sm"
                                                        value="@(editHasVat?.ToString().ToLower() ?? "")"
                                                        @onchange="OnVatChanged">
                                                    <option value="">-- Needs Review --</option>
                                                    <option value="true">VAT Included</option>
                                                    <option value="false">No VAT</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small mb-1">&nbsp;</label>
                                                <div class="form-check mt-1">
                                                    <input type="checkbox" class="form-check-input" id="isPrivate"
                                                           @bind="editIsPrivate" />
                                                    <label class="form-check-label" for="isPrivate">
                                                        <i class="bi bi-lock me-1"></i>Private transaction
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                @* Memo *@
                                <div class="card">
                                    <div class="card-header py-2">
                                        <small class="fw-bold">Memo</small>
                                    </div>
                                    <div class="card-body">
                                        <textarea class="form-control form-control-sm" rows="2"
                                                  placeholder="Optional memo..."
                                                  @bind="editMemo"></textarea>
                                        @if (!string.IsNullOrEmpty(project.GetNote()))
                                        {
                                            <small class="text-muted d-block mt-2">
                                                <strong>Original note:</strong> @project.GetNote()
                                            </small>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <div class="modal-footer">
                    <div class="me-auto">
                        <button type="button" class="btn btn-outline-warning" @onclick="RescanAsync"
                                disabled="@(isSaving || isRescanning)" title="Re-run OCR with fallback patterns">
                            @if (isRescanning)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            else
                            {
                                <i class="bi bi-arrow-repeat me-1"></i>
                            }
                            Rescan OCR
                        </button>
                    </div>
                    <button type="button" class="btn btn-secondary" @onclick="Close">
                        Cancel
                    </button>
                    <button type="button" class="btn btn-primary" @onclick="SaveAsync" disabled="@(isSaving || isRescanning)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check me-1"></i>Save
                    </button>
                    <button type="button" class="btn btn-success" @onclick="SaveAndCloseAsync" disabled="@(isSaving || isRescanning)">
                        @if (isSaving)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        <i class="bi bi-check-all me-1"></i>Save & Close
                    </button>
                </div>
            </div>
        </div>
    </div>
}
