@page "/settings/google-sheets"
@using NewwaysAdmin.WebAdmin.Components.Settings.GoogleSheets
@using NewwaysAdmin.WebAdmin.Components.Settings.GoogleSheets.Models
@using NewwaysAdmin.WebAdmin.Components.Settings.GoogleSheets.Designer
@using NewwaysAdmin.WebAdmin.Services
@inject IJSRuntime JSRuntime
@inject IUnifiedTemplateService TemplateService

<div class="google-sheets-settings">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">Google Sheets Templates</h4>
            <p class="text-muted mb-0">Create and manage your Google Sheets templates</p>
        </div>
    </div>

    @if (_currentMode == DisplayMode.Welcome)
    {
        <WelcomePanel OnGetStarted="HandleGetStarted" 
                      OnCreateBasic="async () => await ShowDesigner(TemplateType.Basic)"
                      OnCreateEnhanced="async () => await ShowDesigner(TemplateType.Enhanced)" />
    }
    else if (_currentMode == DisplayMode.List)
    {
        <TemplateList Templates="_templates"
                      OnCreateNew="HandleCreateNew"
                      OnEditTemplate="HandleEditTemplate"
                      OnDeleteTemplate="HandleDeleteTemplate"
                      OnDuplicateTemplate="HandleDuplicateTemplate" />
    }
    else if (_currentMode == DisplayMode.Designer)
    {
        <div class="designer-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5>@(_isEditing ? "Edit Template" : "Create New Template")</h5>
                <button class="btn btn-outline-secondary btn-sm" @onclick="ReturnToList">
                    <i class="bi bi-arrow-left"></i> Back to Templates
                </button>
            </div>

            @if (_selectedTemplateType == TemplateType.Basic)
            {
                <BasicTemplateDesigner Template="_currentTemplate"
                                     OnSave="HandleTemplateSaved"
                                     OnCancel="ReturnToList" />
            }
            else
            {
                <EnhancedTemplateDesigner Template="_currentTemplate"
                                        OnSave="HandleTemplateSaved"
                                        OnCancel="ReturnToList" />
            }
        </div>
    }
</div>

@code {
    private DisplayMode _currentMode = DisplayMode.Welcome;
    private TemplateType _selectedTemplateType = TemplateType.Basic;
    private List<GoogleSheetTemplate> _templates = new();
    private GoogleSheetTemplate? _currentTemplate;
    private bool _isEditing = false;

    protected override async Task OnInitializedAsync()
    {
        await LoadTemplates();
        
        // If user has templates, show list instead of welcome
        if (_templates.Any())
        {
            _currentMode = DisplayMode.List;
        }
    }

    private async Task LoadTemplates()
    {
        try
        {
            _templates = await TemplateService.GetAllTemplatesAsync();
        }
        catch (Exception ex)
        {
            // TODO: Show error message to user
            Console.WriteLine($"Error loading templates: {ex.Message}");
            _templates = new List<GoogleSheetTemplate>();
        }
    }

    private void HandleGetStarted()
    {
        _currentMode = DisplayMode.List;
    }

    private async Task HandleCreateNew()
    {
        // Show template type selection or default to basic
        await ShowDesigner(TemplateType.Basic);
    }

    private async Task ShowDesigner(TemplateType templateType)
    {
        _selectedTemplateType = templateType;
        
        // Option to create from default template
        try
        {
            _currentTemplate = await TemplateService.CreateDefaultTemplateAsync(templateType, "New Template");
            _currentTemplate.Id = ""; // Clear ID so it will be treated as new
        }
        catch
        {
            // Fallback to manual creation
            _currentTemplate = new GoogleSheetTemplate 
            { 
                Type = templateType,
                CreatedDate = DateTime.Now,
                LastModified = DateTime.Now
            };
            
            // Initialize based on template type
            if (templateType == TemplateType.Enhanced)
            {
                _currentTemplate.Formatting = new TemplateFormatting();
                _currentTemplate.DataColumns = new List<DataColumnTemplate>();
                _currentTemplate.CheckboxColumns = new List<CheckboxColumnTemplate>();
                _currentTemplate.FormulaRows = new List<FormulaRowTemplate>();
            }
            else
            {
                _currentTemplate.Columns = new List<ColumnDefinition>();
                _currentTemplate.Formulas = new List<FormulaDefinition>();
            }
        }
        
        _isEditing = false;
        _currentMode = DisplayMode.Designer;
    }

    private void HandleEditTemplate(GoogleSheetTemplate template)
    {
        _currentTemplate = template;
        _selectedTemplateType = template.Type;
        _isEditing = true;
        _currentMode = DisplayMode.Designer;
    }

    private async Task HandleDeleteTemplate(GoogleSheetTemplate template)
    {
        var confirmed = await JSRuntime.InvokeAsync<bool>("confirm", 
            $"Are you sure you want to delete '{template.Name}'?");
        
        if (confirmed)
        {
            try
            {
                var success = await TemplateService.DeleteTemplateAsync(template.Id);
                if (success)
                {
                    _templates.Remove(template);
                    StateHasChanged();
                }
                else
                {
                    // TODO: Show error message to user
                    Console.WriteLine("Failed to delete template");
                }
            }
            catch (Exception ex)
            {
                // TODO: Show error message to user
                Console.WriteLine($"Error deleting template: {ex.Message}");
            }
        }
    }

    private async Task HandleDuplicateTemplate(GoogleSheetTemplate template)
    {
        try
        {
            var newName = $"{template.Name} (Copy)";
            var success = await TemplateService.DuplicateTemplateAsync(template.Id, newName);
            
            if (success)
            {
                // Reload templates to show the new one
                await LoadTemplates();
                StateHasChanged();
            }
            else
            {
                // TODO: Show error message to user
                Console.WriteLine("Failed to duplicate template");
            }
        }
        catch (Exception ex)
        {
            // TODO: Show error message to user
            Console.WriteLine($"Error duplicating template: {ex.Message}");
        }
    }

    private async Task HandleTemplateSaved(GoogleSheetTemplate template)
    {
        try
        {
            var success = await TemplateService.SaveTemplateAsync(template);
            
            if (success)
            {
                if (_isEditing)
                {
                    var index = _templates.FindIndex(t => t.Id == template.Id);
                    if (index >= 0)
                    {
                        _templates[index] = template;
                    }
                }
                else
                {
                    _templates.Add(template);
                }

                ReturnToList();
            }
            else
            {
                // TODO: Show error message to user
                Console.WriteLine("Failed to save template");
            }
        }
        catch (Exception ex)
        {
            // TODO: Show error message to user
            Console.WriteLine($"Error saving template: {ex.Message}");
        }
    }

    private void ReturnToList()
    {
        _currentMode = DisplayMode.List;
        _currentTemplate = null;
        _isEditing = false;
    }   
}